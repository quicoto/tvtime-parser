const date = require('./utils/date.js');

const fs = require('fs');

try {
  const skipLines = [
    '',
    'All',
    'Recently watched'
  ]
  let shows = [];

  // read contents of the file
  const data = fs.readFileSync('input.txt', 'UTF-8');

  // split the contents by new line
  const lines = data.split(/\r?\n/);

  // print all lines
  lines.forEach((line) => {
    // Skip certain lines
    if (skipLines.indexOf(line.trim()) > -1) return;

    // Since the copy and paste will bring also the image
    // You might have repeated lines. Avoid those.
    if (shows.indexOf(line.trim()) > -1) return

    shows.push(line.trim());
  });

  // Double check is ordered by name
  shows = shows.sort();

  // Save output
  let content = '';
  content += "# TV Time parser";
  content += "\n\n";
  content += "Generate an HTML output of your tv shows.";
  content += "\n\n";
  content += "## Instructions";
  content += "\n\n";
  content += "1. Copy and paste your profile into `input.txt`";
  content += "\n\n";
  content += "2. Via Github Actions or in your terminal `npm run build`";
  content += "\n\n";
  content += "3. `README.md` should be updated with the HTML.";
  content += "\n\n";
  content += "<hr />";
  content += "\n\n";

  const dateOptions = {
    month: 'long',
  };

  content += `<p><small>Updated: ${new Intl.DateTimeFormat('en-US', dateOptions).format(new Date())} ${date.formatNumber(new Date().getDate())}, ${new Date().getFullYear()}</small></p>`;
  content += "\n\n";
  content += "<h3>üçø Recently Watched</h3>";
  content += "\n\n";
  content += "<ul>";
    for (let i = 0, len = shows.length; i < len; i++) {
      if (shows[i] === 'All shows') {
        content += "\n";
        content += "</ul>";
        content += "\n\n";
        content += "<h3>üì∫ All Shows</h3>";
        content += "\n\n";
        content += "<ul>";
      } else {
        content += "\n";
        content += ` <li><a rel="nofollow" title="Search on IMDB...." href="http://imdb.com/find?q=${shows[i]}">${shows[i]}</a></li>`;
      }
    }
  content += "\n";
  content += "</ul>";
  content += "\n\n";
  content += '<p><small>Generated by <a href="https://github.com/quicoto/tvtime-parser">TV Time parser</a></small>';


  fs.writeFile('README.md', content, err => {
    if (err) {
      console.error(err)
      return
    }
    // eslint-disable-next-line no-console
    console.log('README saved successfully!')
  })
} catch (err) {
    console.error(err);
}